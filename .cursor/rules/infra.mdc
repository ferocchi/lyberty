---
description: infrastructure, from hosting to networking SLOs and runbooks
alwaysApply: false
---

# Infrastructure â€“ Hosting, Networking, SLOs & Runbooks

_Last updated: 2â€¯Augâ€¯2025_

> Complements [`backend.mdc`](../backend.mdc) (logic & DB) and [`overview.mdc`](../overview.mdc) (bigâ€‘picture).
> **TL;DR:** Cloudflareâ€‘first edge architecture, threeâ€‘tier data strategy, strict SLOs, and lightweight runbooks for every critical component.

---

## 1â€‚Hosting Topology

| Layer         | Service                            | Purpose                           | Domain           |
| ------------- | ---------------------------------- | --------------------------------- | ---------------- |
| Marketing     | **Cloudflare Pages (Edge Render)** | SEO pages, docs, blog             | `lyberty.ai`     |
| Webâ€¯App       | **Cloudflare Pages (Static)**      | SPA bundle + hydration            | `app.lyberty.ai` |
| API Edge      | **Cloudflare Workers (Nodeâ€¯20)**   | Server Actions, REST, Webhooks    | `api.lyberty.ai` |
| Heavy Compute | **Workers (Rustâ€¯+â€¯WASM)**          | PDF, funnel compile, ML inference | â€”                |
| DesktopÂ / iOS | **Tauri**                          | Native wrapper (autoâ€‘update)      | â€”                |

_All assets cached via Smart Placement + Regional Prefetch where relevant._

Perfect â€” here are the exact lines you can append right after the Hosting Topology table (i.e. after line 13 in your infra.mdc):

â¸»

Cloudflare Pages Build Matrix

apps/marketing

Framework preset: Next.js
Build command: cd apps/marketing && pnpm build
Output directory: apps/marketing/.next
Root directory: /

Environment Variables:

NODE_VERSION=18
PNPM_VERSION=10.14.0
NEXT_TELEMETRY_DISABLED=1

Features enabled:
â€¢ âœ… Edge Middleware
â€¢ âœ… Server Components
â€¢ âœ… Image Optimization
â€¢ âœ… API Routes
â€¢ âœ… Server Actions
â€¢ âœ… Dynamic Routes
â€¢ âœ… SEO & Social Sharing

â¸»

apps/web

Framework preset: Next.js
Build command: cd apps/web && pnpm build
Output directory: apps/web/out
Root directory: /

Environment Variables:

NODE_VERSION=18
PNPM_VERSION=10.14.0
NEXT_TELEMETRY_DISABLED=1

Features enabled:
â€¢ âœ… Static Export (for Tauri wrapping)
â€¢ âœ… Client-side Routing & State
â€¢ âœ… Offline Support
â€¢ âœ… Native App Performance

â¸»

ğŸ’¡ These settings are mirrored in GitHub Actions and Cloudflare Pages UI; use them to debug deploy mismatches or replicate production locally.

---

## 2â€‚Networking & Security

- **DNS:** Cloudflare, CNAMEâ€‘flattened apex.
- **SSL:** Universal SSL (ECDSA certs, TLSâ€¯1.3).
- **WAF & Bot:** Cloudflare Managed Rules + Bot Management (Business plan).
- **Argo Tunnel (optional):** admin tools under Zeroâ€‘Trust.

### Reserved Subâ€‘domains

`www` marketing â€¢ `app` SPA â€¢ `api` JSON/Edge â€¢ `cdn` assets/R2 â€¢ `dev` previews.

---

## 3â€‚SLOs (Serviceâ€‘Level Objectives)

| Component      | Metric             | Target         | Alert at    |
| -------------- | ------------------ | -------------- | ----------- |
| Marketing TTFB | <50â€¯ms global p95  | PageSpeed â©¾95  | p95 >80â€¯ms  |
| API Latency    | <150â€¯ms global p95 | Server Actions | p95 >250â€¯ms |
| Ingest Lag     | Event â†’ Dest       | <1â€¯s p95       | >2â€¯s        |
| Error Rate     | 5xx % of req       | <0.2â€¯%         | >0.5â€¯%      |
| R2 PUT p95     | <80â€¯ms             | asset upload   | >120â€¯ms     |
| D1 Write       | <5â€¯ms inâ€‘POP       | temp_event     | >20â€¯ms      |
| Supabase Write | <120â€¯ms p95        | core tables    | >200â€¯ms     |

Alerts pipe to `#alerts` Slack via Sentry + CF Logpush.

---

## 4â€‚Runbooks

### 4.1 Incident Response (P0)

1. **PageOps** receives Slack â€œğŸ”¥ P0â€ from Sentry.
2. Check Cloudflare Analytics for spike / WAF blocks.
3. Roll back Pages to previous deployment (`pages rollback <id>`).
4. If Workers failing â†’ `wrangler tail --triggers exception`.
5. Mitigate within 30â€¯min; postâ€‘mortem in 24â€¯h.

### 4.2 Durable Objects Cutâ€‘over

Trigger: RPM >50â€¯k OR routing reâ€‘allocation latency breach.

1. Deploy new DO class `VariantBucket`.
2. Replay last 6â€¯h variant assignments from D1 â†’ DO KV.
3. Gradually shift 10â€¯% traffic via feature flag.
4. Monitor allocation accuracy.
5. Complete 100â€¯% in 60â€¯min; deprecate old KV path.

### 4.3 Hyperdrive Activation

Trigger: Supabase p99 write >200â€¯ms across 3 geographic cohorts.

1. `wrangler hyperdrive create lybertyâ€pg`.
2. Update env var `DATABASE_URL_EDGE`.
3. Run smoke tests via preview env.
4. Flip production flag; monitor write latency.

### 4.4 Queue Scaling

Trigger: creative render job >30â€¯s OR daily jobs >500.

1. Create Queue `creativeâ€jobs` with maxÂ attemptsÂ =Â 5.
2. Move Worker logic into consumer (rust/wasm as needed).
3. Add DLQ (deadâ€‘letter) alert to PostHog.
4. Enable autoâ€‘scaling concurrencyÂ =Â 100.

### 4.5 OrioleDB / TigerDB Migration

Trigger: events >5â€¯M/day or analytical query >2â€¯s p95.

1. Provision OrioleDB plugâ€‘in on PG readâ€‘replica **or** TigerDB 7TS external.
2. Copy last 90â€¯days events via `COPY` â†’ S3 â†’ import.
3. Shadow queries in background; compare checksums.
4. Switch OLAP endpoints; update Grafana/PostHog source.

---

## 5â€‚Secrets & Config Rotation

| Scope           | Tool               | Rotation                          |
| --------------- | ------------------ | --------------------------------- |
| Workers Runtime | CFâ€¯Secrets         | monthly or on credential leak     |
| Buildâ€‘time      | GitHub Env Secrets | daily OIDC token refresh          |
| Local           | `.env`             | dev responsibility                |
| KV Flags        | Cloudflare KV      | live toggle (recorded in PostHog) |

---

## 6â€‚Cost Guardrails (Augâ€¯2025 prices)

| Layer   | Free tier        | Watchâ€‘point                  |
| ------- | ---------------- | ---------------------------- |
| Workers | 100â€¯k/day        | >10â€¯M/mo â€“ add cache headers |
| D1      | 25â€¯k writes/day  | >500â€¯k â€“ shard or index      |
| R2      | 10â€¯GB            | >1â€¯TB â€“ cold tier            |
| Queues  | 100â€¯k msgs first | >5â€¯M â€“ renegotiate plan      |

Monthly cost dashboard in PostHog; threshold alerts to `#finance`.

---

**Principle:** _Ship fast, scale precisely._ Every runbook is a oneâ€‘day switch, every SLO is measurable, and every component ties back to the core promise: **leverage without latency**.
